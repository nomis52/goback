# Bazel Migration Summary

This document summarizes the Bazel 9 setup that has been configured for the goback project.

## Files Created/Modified

### New Files

1. **MODULE.bazel** - Bazel module configuration (bzlmod)
   - Declares module dependencies (rules_go, gazelle)
   - Configures Go SDK 1.23.2
   - Manages Go dependencies from go.mod

2. **WORKSPACE** - Minimal compatibility file for older Bazel versions

3. **BUILD.bazel** (root) - Root build configuration
   - Gazelle targets for BUILD file generation
   - Convenient aliases: //:goback, //:goback-server, //:goback-poweroff

4. **BUILD.bazel files** (auto-generated by gazelle)
   - Generated in all package directories
   - Defines go_library, go_binary, and go_test targets
   - Includes x_defs for build-time variable injection

5. **.bazelrc** - Bazel configuration
   - Pure Go builds (CGO_ENABLED=0)
   - Static linking
   - Workspace status command
   - Test configuration

6. **.bazelversion** - Pins Bazel version to 9.0.0

7. **workspace_status.sh** - Provides build-time variables
   - Git commit hash
   - Build timestamp

8. **BAZEL.md** - Comprehensive Bazel usage guide

### Modified Files

1. **.gitignore** - Added Bazel artifacts
   - `/bazel-*` directories
   - `.bazel-cache`

## Quick Start

```bash
# Install bazelisk (if not already installed)
curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.25.0/bazelisk-linux-arm64 -o bazel
chmod +x bazel
sudo mv bazel /usr/local/bin/

# Build all binaries
bazel build //...

# Run tests
bazel test //...

# Run a binary
bazel run //:goback -- --version
```

## Feature Parity with Makefile

| Feature | Makefile | Bazel |
|---------|----------|-------|
| Build CLI | `make build-cli` | `bazel build //cmd/cli` |
| Build Server | `make build-server` | `bazel build //cmd/server` |
| Build Power-off | `make build-poweroff` | `bazel build //cmd/power_off` |
| Build All | `make build` | `bazel build //...` |
| Run Tests | `make test` | `bazel test //...` |
| Clean | `make clean` | `bazel clean` |
| Version Info | ✓ (via ldflags) | ✓ (via workspace_status) |
| CGO Disabled | ✓ (CGO_ENABLED=0) | ✓ (--pure flag) |
| Static Linking | ✓ | ✓ (--static flag) |

## Advantages of Bazel

1. **Incremental Builds** - Only rebuilds changed code
2. **Caching** - Shared cache across builds (disk and remote)
3. **Parallel Execution** - Automatic parallelization
4. **Hermetic Builds** - Reproducible builds
5. **Dependency Management** - Strict dependency tracking
6. **Cross-platform** - Better cross-compilation support

## Testing Results

All 10 test suites pass:
- ✓ clients/ipmiclient
- ✓ clients/pbsclient
- ✓ clients/proxmoxclient
- ✓ config
- ✓ logging
- ✓ metrics
- ✓ server/cron
- ✓ server/handlers
- ✓ server/runner
- ✓ workflow

## Build Verification

Binary version information is correctly injected:
```
goback
Built: 2026-01-30_02:32:18
Commit: ce0aa43
```

## Next Steps

The Makefile can now be deprecated in favor of Bazel. Consider:

1. Update CI/CD pipelines to use Bazel
2. Configure remote caching for faster CI builds
3. Set up remote execution for distributed builds
4. Update documentation to reference Bazel commands

## Maintenance

### Updating Dependencies

When go.mod changes:
```bash
bazel run //:gazelle-update-repos
bazel run //:gazelle
```

### Adding New Packages

After adding new Go files:
```bash
bazel run //:gazelle
```

This automatically generates/updates BUILD.bazel files.
